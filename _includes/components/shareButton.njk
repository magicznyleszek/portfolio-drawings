<script>
  const shareImageAsset = async (imageUrl, pageUrl, title) => {
    const response = await fetch(imageUrl.toString());
    const blob = await response.blob();

    const filesArray = [
      new File([blob], imageUrl, {
        type: 'image/jpeg',
        lastModified: new Date().getTime(),
      }),
    ];
    const shareData = {
      title: title,
      url: pageUrl,
      files: filesArray,
    };

    console.info('shareImageAsset final data:', shareData);

    if (navigator.canShare && navigator.canShare(shareData)) {
      await navigator.share(shareData);
    }
  };

  // Attach click handlers to any buttons with the am-shareButton attribute.
  // This reads values from data-* attributes, avoiding inline quoting issues.
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[am-shareButton]').forEach(btn => {
      btn.addEventListener('click', () => {
        const imageUrl = btn.dataset.imageUrl;
        const pageUrl = btn.dataset.pageUrl;
        const title = btn.dataset.title; // apostrophes come through correctly when using HTML entity escaping
        shareImageAsset(imageUrl, pageUrl, title);
      });
    });
  });
</script>

<button
  title="Share"
  am-shareButton
  data-image-url="{{ params.imageUrl }}"
  data-page-url="{{ params.pageUrl }}"
  data-title="{{ params.title | escape }}"
>&heartsuit;</button>
